<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="cache-control" content="no-store">
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="cache-control" content="max-age=0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=0.8, maximum-scale=1, user-scalable=no, minimal-ui">
    <!--title>Login</title-->

</head>

<body onload = "initialize()">
<h1>Jay Nana Maharaj ji</h1>
<h2 id="result"></h2>
<h3 id="result2"></h3>
<h2 id="test"></h2>
<h3 id="log"></h3>
</body>
<script lang="JavaScript">
    var sessionToken = null;
    initialize = function(e) {
        document.getElementById("test").innerHTML = "test...";
        elt = document.getElementById("log");
        log(`Starting...`);
        getDeviceInfo();
        //authenticate();
    }

    function log(msg) {
        elt.innerHTML = `${elt.innerHTML}${msg}<br/>`;
    }

    function getDeviceInfo2() {
        log("getting device info...");
        return authenticate()
        .then(responseText => {
            fetchDeviceInfo()
                    .then(responseText => {
                            log(`getDeviceInfo API call successful:  ${responseText}`);
                            return responseText;
                        })
                        .catch(error => {
                            console.error(`getDeviceInfo API call failed: ${error.message}`);
                        });;

        })
        .catch(error => {
            console.error(`getDeviceInfo API call failed: ${error.message}`);
        });
    }


    function getDeviceInfo() {
        log("getting device info...");
        return authenticate()
        .then(responseText => {
        setTimeout(() => {
            log("starting session number 1");
            startSession()
            .then(responseText => {
                    log(`start session API call successful 3:  ${responseText}`);
                    /*fetchDeviceInfo()
                    .then(responseText => {
                            log(`getDeviceInfo API call successful:  ${responseText}`);
                            return responseText;
                        })
                        .catch(error => {
                            console.error(`getDeviceInfo API call failed: ${error.message}`);
                        });;*/
                })
                .catch(error => {
                    console.error(`start API call failed 3: ${error.message}`);
                });;
                }, 10000);

        })
        .catch(error => {
            console.error(`getDeviceInfo API call failed: ${error.message}`);
        });
    }

    function startSession(){
        log("starting session...");
        let endpoint = `https://192.168.1.1/api/usersession/sessions/${sessionToken}`;
        let method = 'GET';
        return callAPI(endpoint, method)
            .then(responseText => {
                log(`session start API call successful 2:  ${responseText}`);
                return responseText;
            })
            .catch(error => {
                log(`session start API call failed 2: ${error.message}`);
            });
    }

    function fetchDeviceInfo() {
        log("fetching device info...");
        let endpoint = "https://192.168.1.1/api/deviceinfo";
        let method = 'GET';
        return callAPI(endpoint, method)
            .then(responseText => {
                log(`deviceInfo API call successful:  ${responseText}`);
                return responseText;
            })
            .catch(error => {
                log(`deviceInfo API call failed: ${error.message}`);
            });
    }

    function authenticate() {
        log("authenticating...");
        let endpoint = "https://192.168.1.1/api/usersession";
        let method = 'PUT';
        let requestData = {"login":"admin","password":"admin","logout":false};
        return callAPI(endpoint, method, requestData)
            .then(responseText => {
                log(`authenticate API call successful:  ${responseText}`);
                sessionToken = JSON.parse(responseText).sessionToken;

                return sessionToken;
            })
            .catch(error => {
                log(`authenticate API call failed: ${error.message}`);
            });
    }



    function callAPI(endpoint, method = 'GET', data = null) {
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open(method, endpoint);
            xhr.withCredentials = true;

        //xhr.setRequestHeader('Accept', 'application/json, text/javascript, */*; q=0.01');
        //xhr.setRequestHeader('Accept-Language', 'en-US,en;q=0.9,mr;q=0.8,en-IN;q=0.7');
        //xhr.setRequestHeader('Cache-Control', 'no-cache');
        //xhr.setRequestHeader('Content-Type', 'application/json');
        //xhr.setRequestHeader('Pragma', 'no-cache');
        //xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

            if(sessionToken !== null) {
                // Set the session cookie in the request header
                log(`setting session token: ${sessionToken}`);
                xhr.setRequestHeader('Cookie', `lsid=JfNWWMoLrgaKoNrr; username=admin; session=${sessionToken}`);
                Android.setJavaVariable(`lsid=JfNWWMoLrgaKoNrr; username=admin; session=${sessionToken} SameSite=None;`);
            }
            else {
                log(`Session token not found`);
            }

            xhr.onreadystatechange = function() {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        resolve(xhr.responseText);
                    } else {
                        reject(new Error(`--API request ${xhr.responseURL} failed with status ${xhr.status}`));
                    }
                }
            };

            if (data) {
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.send(JSON.stringify(data));
            } else {
                xhr.send();
            }
        });
    }


</script>
</html>
